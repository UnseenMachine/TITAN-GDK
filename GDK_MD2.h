#ifndef GDK_MD2_H
#define GDK_MD2_H


// Internal Quake 2 Normal Table (162 vectors)
static float g_md2_normals[162][3] = {
    {-0.525731f, 0.000000f, 0.850651f}, {-0.442285f, 0.285888f, 0.850651f}, {-0.295442f, 0.478037f, 0.850651f}, {-0.000000f, 0.517638f, 0.855481f}, {0.163320f, 0.442285f, 0.881677f},
    {0.363271f, 0.263973f, 0.893997f}, {0.525731f, 0.000000f, 0.850651f}, {0.426859f, -0.302323f, 0.850651f}, {0.262513f, -0.490730f, 0.835900f}, {0.000000f, -0.550836f, 0.834614f},
    {-0.220526f, -0.520442f, 0.824707f}, {-0.440250f, -0.285450f, 0.850651f}, {-0.850651f, 0.000000f, 0.525731f}, {-0.716189f, 0.285888f, 0.636633f}, {-0.525731f, 0.478037f, 0.707107f},
    {-0.220526f, 0.678708f, 0.699663f}, {0.000000f, 0.729111f, 0.684395f}, {0.262513f, 0.638424f, 0.723164f}, {0.525731f, 0.478037f, 0.707107f}, {0.716189f, 0.285888f, 0.636633f},
    {0.850651f, 0.000000f, 0.525731f}, {0.755493f, -0.285888f, 0.587785f}, {0.590210f, -0.478037f, 0.654508f}, {0.334935f, -0.678708f, 0.651168f}, {0.000000f, -0.809017f, 0.587785f},
    {-0.334935f, -0.678708f, 0.651168f}, {-0.590210f, -0.478037f, 0.654508f}, {-0.755493f, -0.285888f, 0.587785f}, {-0.850651f, 0.000000f, -0.525731f}, {-0.716189f, 0.285888f, -0.636633f},
    {-0.525731f, 0.478037f, -0.707107f}, {-0.220526f, 0.678708f, -0.699663f}, {0.000000f, 0.729111f, -0.684395f}, {0.262513f, 0.638424f, -0.723164f}, {0.525731f, 0.478037f, -0.707107f},
    {0.716189f, 0.285888f, -0.636633f}, {0.850651f, 0.000000f, -0.525731f}, {0.755493f, -0.285888f, -0.587785f}, {0.590210f, -0.478037f, -0.654508f}, {0.334935f, -0.678708f, -0.651168f},
    {0.000000f, -0.809017f, -0.587785f}, {-0.334935f, -0.678708f, -0.651168f}, {-0.590210f, -0.478037f, -0.654508f}, {-0.755493f, -0.285888f, -0.587785f}, {-0.525731f, 0.000000f, -0.850651f},
    {-0.442285f, 0.285888f, -0.850651f}, {-0.295442f, 0.478037f, -0.850651f}, {0.000000f, 0.517638f, -0.855481f}, {0.163320f, 0.442285f, -0.881677f}, {0.363271f, 0.263973f, -0.893997f},
    {0.525731f, 0.000000f, -0.850651f}, {0.426859f, -0.302323f, -0.850651f}, {0.262513f, -0.490730f, -0.835900f}, {0.000000f, -0.550836f, -0.834614f}, {-0.220526f, -0.520442f, -0.824707f},
    {-0.440250f, -0.285450f, -0.850651f}, {0.000000f, 1.000000f, 0.000000f}, {0.165416f, 0.986224f, 0.000000f}, {0.316707f, 0.948517f, 0.000000f}, {0.453991f, 0.891007f, 0.000000f},
    {0.573576f, 0.819152f, 0.000000f}, {0.671559f, 0.740951f, 0.000000f}, {0.745113f, 0.666938f, 0.000000f}, {0.791353f, 0.611354f, 0.000000f}, {0.809017f, 0.587785f, 0.000000f},
    {0.809017f, 0.587785f, 0.000000f}, {0.745113f, 0.666938f, 0.000000f}, {0.587785f, 0.809017f, 0.000000f}, {0.316707f, 0.948517f, 0.000000f}, {0.000000f, 1.000000f, 0.000000f},
    {-0.316707f, 0.948517f, 0.000000f}, {-0.587785f, 0.809017f, 0.000000f}, {-0.745113f, 0.666938f, 0.000000f}, {-0.809017f, 0.587785f, 0.000000f}, {-0.809017f, 0.587785f, 0.000000f},
    {-0.791353f, 0.611354f, 0.000000f}, {-0.745113f, 0.666938f, 0.000000f}, {-0.671559f, 0.740951f, 0.000000f}, {-0.573576f, 0.819152f, 0.000000f}, {-0.453991f, 0.891007f, 0.000000f},
    {-0.316707f, 0.948517f, 0.000000f}, {-0.165416f, 0.986224f, 0.000000f}, {0.000000f, 0.000000f, 1.000000f}, {0.165416f, 0.000000f, 0.986224f}, {0.316707f, 0.000000f, 0.948517f},
    {0.453991f, 0.000000f, 0.891007f}, {0.573576f, 0.000000f, 0.819152f}, {0.671559f, 0.000000f, 0.740951f}, {0.745113f, 0.000000f, 0.666938f}, {0.791353f, 0.000000f, 0.611354f},
    {0.809017f, 0.000000f, 0.587785f}, {0.809017f, 0.000000f, 0.587785f}, {0.745113f, 0.000000f, 0.666938f}, {0.587785f, 0.000000f, 0.809017f}, {0.316707f, 0.000000f, 0.948517f},
    {0.000000f, 0.000000f, 1.000000f}, {-0.316707f, 0.000000f, 0.948517f}, {-0.587785f, 0.000000f, 0.809017f}, {-0.745113f, 0.000000f, 0.666938f}, {-0.809017f, 0.000000f, 0.587785f},
    {-0.809017f, 0.000000f, 0.587785f}, {-0.791353f, 0.000000f, 0.611354f}, {-0.745113f, 0.000000f, 0.666938f}, {-0.671559f, 0.000000f, 0.740951f}, {-0.573576f, 0.000000f, 0.819152f},
    {-0.453991f, 0.000000f, 0.891007f}, {-0.316707f, 0.000000f, 0.948517f}, {-0.165416f, 0.000000f, 0.986224f}, {0.000000f, 0.000000f, -1.000000f}, {-0.165416f, 0.000000f, -0.986224f},
    {-0.316707f, 0.000000f, -0.948517f}, {-0.453991f, 0.000000f, -0.891007f}, {-0.573576f, 0.000000f, -0.819152f}, {-0.671559f, 0.000000f, -0.740951f}, {-0.745113f, 0.000000f, -0.666938f},
    {-0.791353f, 0.000000f, -0.611354f}, {-0.809017f, 0.000000f, -0.587785f}, {-0.809017f, 0.000000f, -0.587785f}, {-0.745113f, 0.000000f, -0.666938f}, {-0.587785f, 0.000000f, -0.809017f},
    {-0.316707f, 0.000000f, -0.948517f}, {0.000000f, 0.000000f, -1.000000f}, {0.316707f, 0.000000f, -0.948517f}, {0.587785f, 0.000000f, -0.809017f}, {0.745113f, 0.000000f, -0.666938f},
    {0.809017f, 0.000000f, -0.587785f}, {0.809017f, 0.000000f, -0.587785f}, {0.791353f, 0.000000f, -0.611354f}, {0.745113f, 0.000000f, -0.666938f}, {0.671559f, 0.000000f, -0.740951f},
    {0.573576f, 0.000000f, -0.819152f}, {0.453991f, 0.000000f, -0.891007f}, {0.316707f, 0.000000f, -0.948517f}, {0.165416f, 0.000000f, -0.986224f}, {0.000000f, -1.000000f, 0.000000f},
    {-0.165416f, -0.986224f, 0.000000f}, {-0.316707f, -0.948517f, 0.000000f}, {-0.453991f, -0.891007f, 0.000000f}, {-0.573576f, -0.819152f, 0.000000f}, {-0.671559f, -0.740951f, 0.000000f},
    {-0.745113f, -0.666938f, 0.000000f}, {-0.791353f, -0.611354f, 0.000000f}, {-0.809017f, -0.587785f, 0.000000f}, {-0.809017f, -0.587785f, 0.000000f}, {-0.745113f, -0.666938f, 0.000000f},
    {-0.587785f, -0.809017f, 0.000000f}, {-0.316707f, -0.948517f, 0.000000f}, {0.000000f, -1.000000f, 0.000000f}, {0.316707f, -0.948517f, 0.000000f}, {0.587785f, -0.809017f, 0.000000f},
    {0.745113f, -0.666938f, 0.000000f}, {0.809017f, -0.587785f, 0.000000f}, {0.809017f, -0.587785f, 0.000000f}, {0.791353f, -0.611354f, 0.000000f}, {0.745113f, -0.666938f, 0.000000f},
    {0.671559f, -0.740951f, 0.000000f}, {0.573576f, -0.819152f, 0.000000f}, {0.453991f, -0.891007f, 0.000000f}, {0.316707f, -0.948517f, 0.000000f}, {0.165416f, -0.986224f, 0.000000f}
};
static bool GDK_Internal_LoadMD2(const char* mPath, GDK_Legacy_Model& model) {
    std::ifstream file(mPath, std::ios::binary);
    if (!file.is_open()) return false;

    MD2_Header h;
    file.read((char*)&h, sizeof(MD2_Header));
    // Check magic number and version
    if (h.magic != 844121161 || h.version != 8) return false; 
    
    // model.defaultTex is already set by GDK_Model_Load(tPath, ...)
    // We only set the mesh metadata here:
    model.numTris = h.num_tris;
    model.numVerts = h.num_tris * 3; 
    model.numFrames = h.num_frames;

    // Load UV & Tri data
    std::vector<MD2_Alias_ST> rawST(h.num_st);
    file.seekg(h.offset_st);
    file.read((char*)rawST.data(), h.num_st * sizeof(MD2_Alias_ST));

    std::vector<MD2_Alias_Triangle> rawTris(h.num_tris);
    file.seekg(h.offset_tris);
    file.read((char*)rawTris.data(), h.num_tris * sizeof(MD2_Alias_Triangle));

    // Simple 1:1 indices for the exploded/flattened mesh
    model.indices.clear();
    model.indices.reserve(h.num_tris * 3);
    for (int i = 0; i < h.num_tris * 3; ++i) model.indices.push_back(i);

    // Coordinate System Transformation Matrix prep
    glm::vec3 targetUp = glm::vec3(0.0f, 1.0f, 0.0f); // Default for GDK

    model.frames.resize(h.num_frames);
    for (int i = 0; i < h.num_frames; ++i) {
        float scale[3], trans[3];
        char fName[16];
        file.seekg(h.offset_frames + (i * h.framesize));
        file.read((char*)scale, 12);
        file.read((char*)trans, 12);
        file.read(fName, 16);

        std::vector<MD2_Alias_Vert> rv(h.num_vertices);
        file.read((char*)rv.data(), h.num_vertices * sizeof(MD2_Alias_Vert));

        model.frames[i].resize(h.num_tris * 3);

        for (int t = 0; t < h.num_tris; ++t) {
            for (int v = 0; v < 3; ++v) {
                GDK_Legacy_Vert& outV = model.frames[i][t * 3 + v];
                int vIdx = rawTris[t].vertex[v];
                int stIdx = rawTris[t].st[v];

                // --- POSITIONS with Transformation ---
                float rawX = (rv[vIdx].v[0] * scale[0]) + trans[0];
                float rawY = (rv[vIdx].v[1] * scale[1]) + trans[1];
                float rawZ = (rv[vIdx].v[2] * scale[2]) + trans[2];

                outV.x = rawX;
                outV.y = rawZ;
                outV.z = -rawY;

                // --- UVs (Flipped for STB compatibility) ---
                outV.u = (float)rawST[stIdx].s / h.skinwidth;
                outV.v = 1.0f - ((float)rawST[stIdx].t / h.skinheight);

                // --- NORMALS with Transformation ---
                int nIdx = rv[vIdx].lightNormalIndex;
                if (nIdx >= 0 && nIdx < 162) {
                    outV.nx = g_md2_normals[nIdx][0];
                    outV.ny = g_md2_normals[nIdx][2];  
                    outV.nz = -g_md2_normals[nIdx][1]; 
                }
            }
        }
    }
    return true;
}


#endif
